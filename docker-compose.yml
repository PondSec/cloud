services:
  workspace-image:
    image: cloudide-workspace:latest
    build:
      context: .
      dockerfile: infra/workspace-image/Dockerfile
    command: ["sleep", "infinity"]

  ide-backend:
    build:
      context: .
      dockerfile: infra/backend.Dockerfile
    environment:
      PORT: 8080
      NODE_ENV: development
      JWT_SECRET: super-secret-jwt-change-me
      APP_ENCRYPTION_KEY: super-secret-encryption-change-me
      DB_PATH: /data/cloudide.db
      WORKSPACES_ROOT: /workspaces
      RUNNER_URL: http://runner:8081
      RUNNER_WS_URL: ws://runner:8081
      WORKSPACE_IMAGE: cloudide-workspace:latest
      WORKSPACE_VOLUME: cloudide-workspaces
      CORS_ORIGIN: http://localhost:5173,http://127.0.0.1:5173,https://cloud.pondsec.com
    volumes:
      - cloudide-db:/data
      - cloudide-workspaces:/workspaces
    ports:
      - '18080:8080'
    depends_on:
      - runner

  runner:
    build:
      context: .
      dockerfile: infra/runner.Dockerfile
    environment:
      PORT: 8081
      DOCKER_BIN: docker
      WORKSPACE_IMAGE: cloudide-workspace:latest
      WORKSPACE_VOLUME: cloudide-workspaces
      WORKSPACE_NETWORK: cloud_default
      WORKSPACES_ROOT: /workspaces
      WORKSPACE_IMAGE_CONTEXT: /infra/workspace-image
      WORKSPACE_IMAGE_DOCKERFILE: /infra/workspace-image/Dockerfile
      DEFAULT_CPU_LIMIT: '1'
      DEFAULT_MEM_LIMIT: 1024m
      DEFAULT_PIDS_LIMIT: '256'
      DEFAULT_ALLOW_EGRESS: 'true'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - cloudide-workspaces:/workspaces
      - ./infra:/infra:ro
    depends_on:
      - workspace-image

volumes:
  cloudide-db:
    name: cloudide-db
  cloudide-workspaces:
    name: cloudide-workspaces
