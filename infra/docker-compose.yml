services:
  workspace-image:
    image: cloudide-workspace:latest
    build:
      context: .
      dockerfile: infra/workspace-image/Dockerfile
    command: ["sleep", "infinity"]

  ide-backend:
    build:
      context: .
      dockerfile: infra/backend.Dockerfile
    # Needs write access to /data (sqlite) and /workspaces (workspace metadata).
    # On Docker Desktop the mounted volumes are owned by root by default; running as root avoids SQLITE_CANTOPEN.
    user: "0:0"
    environment:
      PORT: 8080
      NODE_ENV: ${NODE_ENV:-development}
      JWT_SECRET: ${JWT_SECRET:?set JWT_SECRET}
      APP_ENCRYPTION_KEY: ${APP_ENCRYPTION_KEY:?set APP_ENCRYPTION_KEY}
      DB_PATH: /data/cloudide.db
      WORKSPACES_ROOT: /workspaces
      RUNNER_URL: http://runner:8081
      RUNNER_WS_URL: ws://runner:8081
      WORKSPACE_IMAGE: cloudide-workspace:latest
      WORKSPACE_VOLUME: cloudide-workspaces
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173,http://127.0.0.1:5173}
      RUNNER_SHARED_SECRET: ${RUNNER_SHARED_SECRET:?set RUNNER_SHARED_SECRET}
    volumes:
      - cloudide-db:/data
      - cloudide-workspaces:/workspaces
    ports:
      - '18080:8080'
    depends_on:
      - runner

  runner:
    build:
      context: .
      dockerfile: infra/runner.Dockerfile
    # Needs access to /var/run/docker.sock; on Docker Desktop it's root-owned (660).
    user: "0:0"
    environment:
      PORT: 8081
      DOCKER_BIN: docker
      WORKSPACE_IMAGE: cloudide-workspace:latest
      WORKSPACE_VOLUME: cloudide-workspaces
      WORKSPACE_NETWORK: cloud_default
      WORKSPACES_ROOT: /workspaces
      WORKSPACE_IMAGE_CONTEXT: /infra/workspace-image
      WORKSPACE_IMAGE_DOCKERFILE: /infra/workspace-image/Dockerfile
      DEFAULT_CPU_LIMIT: '1'
      DEFAULT_MEM_LIMIT: 1024m
      DEFAULT_PIDS_LIMIT: '256'
      DEFAULT_ALLOW_EGRESS: 'true'
      RUNNER_SHARED_SECRET: ${RUNNER_SHARED_SECRET:?set RUNNER_SHARED_SECRET}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - cloudide-workspaces:/workspaces
      - ./infra:/infra:ro
    depends_on:
      - workspace-image

volumes:
  cloudide-db:
    name: cloudide-db
  cloudide-workspaces:
    name: cloudide-workspaces
